<h2 class="header-title_page">Editing Workshop</h2>

<!--++++++++++++++++toolbar+++++++++++++++++++++++-->

<div class="toolbar_nav-tab">
  <!--draft-->
  <% unless @workshop.draft %>
    <a class ="btn" href="<%=workshop_path(@workshop)%>">Turn off editing mode</a>
  <%end%>
  <!--delete-->
  <%= link_to "Delete Workshop",  @workshop, :method => :delete, :class => 'btn btn-primary', :confirm => t('workshop.confirm_delete') %>
  <!--publicar-->
  <%= form_for(@workshop) do |f| %>
    <%= f.hidden_field :draft, :value => !@workshop.draft %>
    <%= f.submit (@workshop.draft ? "Publicar" : "Retirar") %>
  <%end%>
</div>

<!--++++++++++++++++header+++++++++++++++++++++++-->

<div class="wa_activity_wrapper wa_activity_wrapper_edit header_workshop ">
  <div class="wa_activity_actions">
    <ul>
      <li>
      <a href=<%=edit_details_path(@workshop)%>><i class="icon-edit"></i></a>
    </li>
    </ul>
  </div>
  <div class="layout_workshop">
    <!--title-->
    <h3 class="title_WS main_title_WS"><%=@workshop.title%></h3>
    <!--avatar-->
    <div class="container-img_WS">
      <div class="dummy"></div>
      <div class="element resource-center">
        <img class="workshop_thumbnail applyBackstretch" src="<%=@workshop.thumbnail_url%>">
      </div>
    </div>
    <!--description-->
    <p class="description_WS"><%=@workshop.description%></p>
  </div>
</div>

<!--++++++++++++++++item+++++++++++++++++++++++-->

<ul class="workshop_activities_list workshop_activities_list_edit">
  <% @workshop_activities.each do |workshop_activity| %>
    <li workshop_activity_id="<%=workshop_activity.id%>" class="workshop_element">
      <div class="wa_activity_wrapper wa_activity_wrapper_edit">

      <!--tool-ITEM-->
        <div class="wa_activity_edit_tools">
          <ul>
            <li class="sorthandler">
              <i class="icon-move"></i>
            </li>
            <% object = workshop_activity.object
              className = object.class.to_s
              classNameUnderscore = className.underscore
              classNameTableize = className.tableize
              hasEditPartial = lookup_context.template_exists?("edit", classNameTableize, true)
            %>
            <% if hasEditPartial %>
              <li class="ui-state-default" data-target="#WorkshopActivity" data-toggle="modal" data-remote=<%="/#{classNameTableize}/#{object.id}/edit.partial"%>>
                <i class="icon-edit"></i>
              </li>
            <% end %>
            <li>
              <%= link_to raw('<i class="icon-trash"></i>'),  workshop_activity.object, :method => :delete, :confirm => t('workshop.activity.confirm_delete') %>
            </li>
          </ul>
        </div>

        <!--content-->
        <% if workshop_activity.wa_type =="WaResource"%>
            <div id="effect<%=workshop_activity.id%>" class="resources_WS oculto" > <!--only for resources-->
       
        <%end%>
          <div class="layout_workshop">
            <% entity = workshop_activity.object %>
            <%className = entity.class.to_s%>
            <%classNameUnderscore = className.underscore%>
            <%= render partial: "#{ className.tableize }/#{ classNameUnderscore }_edit",
                       locals:  { classNameUnderscore.to_sym => entity, :prefix_id => "workshop_activity_"+workshop_activity.id.to_s } %>
          </div>
        <% if workshop_activity.wa_type=="WaResource"%>
          </div>
        <%end%>

      </div>
    </li>




<!--script>
  $(function() {
    $(".showMore").click(function(){
       var mainDiv = $(this).parent().parent().parent();

      if($(this).attr("status")=== "showMore"){
        mainDiv.switchClass( "oculto", "desplegado", 3000);
        $( '.thumbnail_object_WS' ).hide( "slow", function() {
          $( '.show_object_WS' ).show( "drop", { direction: "left" }, 3000 );
        });
        $(this).html('<a><i class="icon-chevron-up"></i><%=t("excursion.actions.show_fewer")%></a>');
        $(this).attr("status", "showFewer");
      }
      else{
        mainDiv.switchClass( "desplegado", "oculto", 1000);
        $( '.show_object_WS' ).hide( "drop", { direction: "left" }, 1000, function() {
          $( '.thumbnail_object_WS' ).show( "drop", { direction: "left" }, 1000 );
        });
        $(this).html('<a><i class="icon-chevron-down"></i><%=t("excursion.actions.show_more")%></a>');
        $(this).attr("status", "showMore");
      }
      return false;
    });
  });
</script-->





<!--script>
  $(function() {
    $(".showMore").click(function(){
       var mainDiv = $(this).parent().parent().parent();

      if($(this).attr("status")=== "showMore"){
        mainDiv.switchClass( "oculto", "desplegado", 3000);
        $( "#effect<%=workshop_activity.id%>" ).hide( "slow", function() {
          $( '.show_object_WS' ).show( "drop", { direction: "left" }, 3000 );
        });
        $(this).html('<a><i class="icon-chevron-up"></i><%=t("excursion.actions.show_fewer")%></a>');
        $(this).attr("status", "showFewer");
      }
      else{
        mainDiv.switchClass( "desplegado", "oculto", 1000);
        $( '.show_object_WS' ).hide( "drop", { direction: "left" }, 1000, function() {
          $( '.thumbnail_object_WS' ).show( "drop", { direction: "left" }, 1000 );
        });
        $(this).html('<a><i class="icon-chevron-down"></i><%=t("excursion.actions.show_more")%></a>');
        $(this).attr("status", "showMore");
      }
      return false;
    });
  });
</script-->









  <%end%>
</ul>




<!--++++++++++++++++ADD ACTIVITY+++++++++++++++++++++++-->

<div class="wa_add_activity_wrapper">
  <a href="#WorkshopActivities" class="btn btn-primary" data-toggle="modal"><p>Add new Activity</p></a>
</div>

<!--++++++++++++++++ MODAL ADD++++++++++++++++++++++-->


<div id="WorkshopActivities" class="modal hide fade" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
    <h3><%=t('workshop.actions.add_activity_title')%></h3>
  </div>
  <div class="modal-body tabbable tabs-below">
    <div id="workshop_activities_column1">
      <ul class="nav nav-tabs">
        <li><a href="#tab_assignment" data-toggle="tab" activityId="assignment"><%=t('workshop.activities.assignment.title')%></a></li>
        <li class="active"><a href="#tab_resource" data-toggle="tab" activityId="resource"><%=t('workshop.activities.resource.title')%></a></li>
        <li><a href="#tab_resource_gallery" data-toggle="tab" activityId="resource_gallery"><%=t('workshop.activities.resource_gallery.title')%></a></li>
        <li><a href="#tab_contributions_gallery" data-toggle="tab" activityId="contributions_gallery"><%=t('workshop.activities.contributions_gallery.title')%></a></li>
        <li><a href="#tab_text" data-toggle="tab" activityId="text"><%=t('workshop.activities.text.title')%></a></li>
      </ul>
    </div>
    <div id="workshop_activities_column2">
      <div class="tab-content">
        <div class="tab-pane" id="tab_assignment">
          <h4><%=t('workshop.activities.assignment.description')%></h4>
          <%= render partial: 'wa_assignments/new', :locals => { :workshop => @workshop } %>
        </div>
        <div class="tab-pane active" id="tab_resource">
          <h4><%=t('workshop.activities.resource.description')%></h4>
          <%= render partial: 'wa_resources/new', :locals => { :workshop => @workshop } %>
        </div>
        <div class="tab-pane" id="tab_resource_gallery">
          <h4><%=t('workshop.activities.resource_gallery.description')%></h4>
          <%= render partial: 'wa_resources_galleries/new', :locals => { :workshop => @workshop } %>
        </div>
        <div class="tab-pane" id="tab_contributions_gallery">
          <h4><%=t('workshop.activities.contributions_gallery.description')%></h4>
          <%= render partial: 'wa_contributions_galleries/new', :locals => { :workshop => @workshop } %>
        </div>
        <div class="tab-pane" id="tab_text">
          <h4><%=t('workshop.activities.text.description')%></h4>
          <%= render partial: 'wa_texts/new', :locals => { :workshop => @workshop } %>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <p><button class="btn btn-primary submitWorkshopActivityFake"><%=t('workshop.actions.add_activity_button')%></button></p>
  </div>
</div>

<!--++++++++++++++++  MODAL EDIT+++++++++++++++++++++++-->

<div id="WorkshopActivity" class="modal hide fade" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
    <h3>Edit</h3>
  </div>
  <div class="modal-body tabbable tabs-below">
      <!-- This body is replaced every time the modal is called -->
  </div>
  <div class="modal-footer">
    <p><button class="btn btn-primary updateWorkshopActivityFake"><%=t('workshop.actions.edit_activity_button')%></button></p>
  </div>
</div>


<script>
  $(document).ready(function(){
    <%= render partial: "application/applyBackstretch", locals: { :includeScriptTag => false } %>

    $('#WorkshopActivities').on('shown', function(){
    });
    $('#WorkshopActivities').on('hidden', function(){
    });

    $('#WorkshopActivity').on('hidden', function(){
      $(this).removeData('modal');
    });

    $(document).on( "click", "#WorkshopActivities .submitWorkshopActivityFake", function(){
      var submitForm = $("#WorkshopActivities  div.tab-pane.active").find("form");
      $(submitForm).submit();
    });

    $(document).on( "click", "#WorkshopActivity .updateWorkshopActivityFake", function(){
      var submitForm = $("#WorkshopActivity").find("form");
      $(submitForm).submit();
    });

    $("ul.workshop_activities_list_edit").sortable({
      handle: ".sorthandler",
      stop: function(event,ui){
        _onDragWorkshopActivity();
      }
    });

    var _lastActivitiesOrder;
    var _onDragWorkshopActivity = function(){
      var activitiesOrder = _getCurrentWorkshopActivitiesOrder();
      if(activitiesOrder!=_lastActivitiesOrder){
        _lastActivitiesOrder = activitiesOrder;
        _sendNewActivitiesOrder(activitiesOrder);
      }
    };

    var _getCurrentWorkshopActivitiesOrder = function(){
      var activitiesOrder = []; 
      $("li[workshop_activity_id]").each(function(index,li){
        activitiesOrder.push($(li).attr("workshop_activity_id"));
      });
      return activitiesOrder;
    };

    var _sendNewActivitiesOrder = function(activitiesOrder){
      //Update workshop with the new activities order
      $.ajax({
        type: "PUT",
        url: '<%=workshop_path(@workshop)%>',
        dataType: 'json',
        data: {
          "workshop_activities_order": JSON.stringify(activitiesOrder)
        },
        success:function(response){
        },
        error:function (xhr, ajaxOptions, thrownError){
          _lastActivitiesOrder = undefined;
        }
      });
    };

  });
</script>




<!--script>
  $(function() {
    $(".showMore").click(function(){
       var mainDiv = $(this).parent();

      if($(this).attr("status")=== "showMore"){
        mainDiv.switchClass( "oculto", "desplegado", 1000);
        $(this).html('<a><%#=t("excursion.actions.show_fewer")%></a>');
        $(this).attr("status", "showFewer");
      }
      else{
        mainDiv.switchClass( "desplegado", "oculto", 1000);
        $(this).html('<a><%#=t("excursion.actions.show_more")%></a>');
        $(this).attr("status", "showMore");

      }
      return false;
    });
  });
</script-->

