<script>
//CAMBIOS con respecto al formulario original. Toda la parte del ckeditor
//quitado todo lo de accordion.
//sitios donde pone XXX
//sustituido AddWriting por AddWriting porque me daba conflicto con el del header los selectores, habr√≠a que hacer refactoring de todo si va bien

  $(document).ready(function() {  
    //Specified CKEditor configuration
    var config = {};


    //Select the features of the toolbar
    config.toolbar = 'Full';
    config.toolbar_Full =
    [
      { name: 'first', items : ['Bold','Italic','Underline','-','Subscript','Superscript','Font','FontSize','TextColor','BGColor'] },
      '/',
      { name: 'lists', items : ['NumberedList','BulletedList','Table'] },
      { name: 'alignment', items : ['JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock'] },
      { name: 'link', items : ['Link'] },
      { name: 'Objects', items : ['Image','MediaEmbed'] },
      { name: 'symbols', items : ['SpecialChar'] }
    ];

    //Disable toolbar expansion
    config.toolbarCanCollapse = false;
    //Disable resizing
    config.resize_enabled = false;
    //Disable bottom tags
    config.removePlugins = 'elementspath';
    //Enable table resize and autogrow
    config.extraPlugins = 'tableresize,autogrow,specialchar,mediaembed';
    
    config.autoGrow_minHeight = 34;
    config.autoGrow_maxHeight = 800;

    //Fit the current area
    config.width = '600px';
    //The height value defines the height of CKEditor editing area and can be given in pixels or em. Percent values are not supported. 
    //http://docs.cksource.com/CKEditor_3.x/Howto/Editor_Size_On_The_Fly
    config.height = "300px";

    //Toolbar defaults
    config.fontSize_defaultLabel = '12';


    //Apply vEditor skin
    var ckeditorBasePath = CKEDITOR.basePath.substr(0, CKEDITOR.basePath.indexOf("editor/"));
    config.skin = 'vEditor,' + CKEDITOR.basePath + '/skins/vEditor/';
    
    //Add ckeditor wysiwyg instance
    var ckeditor = CKEDITOR.replace("new_file_only_writing_plaintext", config);


  });
</script>

<div id="AddWriting" class="">

      <!-- Tags preloaded -->
      <%@tags = ActivityObject.tag_counts(:limit => 100, :order => "count desc")%>
      <ul id="resourcePreloadTagList" style="display:none">
        <%@tags.each do |tag| %>
          <li><%=tag.name%></li>
        <%end%>
      </ul>


          <div id="writing" class="">
            <div class="">
              <% d = Writing.new %>
              <% d.owner_id = Actor.normalize_id(current_subject) %>
              <%= form_for d, :namespace => 'new_file_only', :html => { :multipart => true }, :remote => false do |f| %>
                <%= f.hidden_field :owner_id %>
                <%= f.hidden_field :title%>
                <%= f.hidden_field :description%>
                <%= f.text_area :plaintext %>
                <%= f.hidden_field :fulltext, :value => "" %>
                <%= f.hidden_field :tag_list, :multiple => true %>
                <%= f.hidden_field :language, :value => "" %>
                <%= f.hidden_field :age_min, :value => "4" %>
                <%= f.hidden_field :age_max, :value => "20" %>
                <%= f.submit t('button.save'), :class => "writing hide"%>
              <% end %>
            </div>
          </div>
    
    <div class="layoutform">
      <p><%= t('document.body.title2')%></p>

      <!--TITULO-->
      <label><%= t('document.leyend.title')%></label>
      <input type="text" class="title" placeholder="<%= t('document.title_input')%>">
      
      <!--DESCRIPCION-->
      <label><%= t('document.leyend.description')%></label>
      <textarea type="text" class="description" placeholder="<%= t('document.input')%>"></textarea>

      <!--TAGS-->
      <label><%= t('document.leyend.tags')%></label>

      <div class="tagBoxDocument">
         <ul class="resourceTagList"></ul>
      </div>

      <div class="clearfloat"></div>

      <!--Avatar-->
      <label class="new_file_avatar_label"><%= t('document.leyend.avatar')%></label>
      <input class="new_file_avatar" type="file" accept="image/*">
      
      <!--LANGUAGE-->
      <label><%= t('document.leyend.language')%></label>
      <%= select_tag(:language, resource_language_options_for_select(d.language), :class => "language") %>
      
      <!--AGE SLIDER-->
      <label><%= t('document.leyend.recommended_age')%></label>
      <div class="limits">
        <div class="limit1">4</div>
        <div class="limit2">20</div>
      </div>
      <input type="text" class="age-slider" value="" data-slider-min="0" data-slider-max="30" data-slider-step="1" data-slider-value="[4,20]" data-slider-orientation="horizontal" data-slider-tooltip="hide"/>

      <br>
    </div>

    <div class="modal-footer">
      <input type="button" class="btn btn-primary" data-loading-text="<%= t('document.uploading')%>" value="<%= t('document.upload')%>"/>
    </div>

</div>

<script>

  $(document).ready(function(){
    $('.helpResources').popover({ 
      html : true,
      content: function() {
        return $('.contentHelpResources').html();
      }
    });
  

//XXX no hay shown event
//  $("#AddWriting").on('shown', function(){
    //SLIDER
    var min = 0;
    var max = 30;
    var step = 1;
    var diff = max - min;

    var positionLimits = function(){
      var value1 = $('#AddWriting .age-slider').data('slider').getValue()[0];
      var value2 = $('#AddWriting .age-slider').data('slider').getValue()[1];
      $('#AddWriting .limit1').text(value1);
      $('#AddWriting .limit2').text(value2);

      var percentage =[
        (value1-min)*100/diff,
        (value2-min)*100/diff,
        step*100/diff
      ];

      $("#AddWriting .limit1").css("left", function(ev) {
        return $('#AddWriting .slider').width() * percentage[0]/100 - $("#AddWriting .limit1").width()/2 + 'px';
      });
      $("#AddWriting .limit2").css("left", function(ev) {
        return $('#AddWriting .slider').width() * percentage[1]/100 - $("#AddWriting .limit2").width()/2 + 'px';
      });
    };

    $("#AddWriting .age-slider").slider().on('slide', function(ev){
      positionLimits();
    });

    $("#AddWriting .age-slider").before($("#AddWriting .limits"));
    positionLimits();
//  });


  //COMMON FIELDS
  var uploadButton = $("#AddWriting input[value=<%= t('document.upload')%>][type='button'][class='btn btn-primary']");
  
  $(uploadButton).click(function(event){
    //XXX, resource_type a pincho
     var resource_type = "writing";//$("#AddWriting .accordion-body.collapse.in").attr('id');

     //XXX nuevo
     var plaintext = CKEDITOR.instances.new_file_only_writing_plaintext.document.getBody().getText();
     var fulltext = CKEDITOR.instances.new_file_only_writing_plaintext.getData();

     $("#new_file_only_writing_plaintext").val(plaintext);
     $("#new_file_only_writing_fulltext").val(fulltext);

    if(resource_type == "document" && $("#AddWriting input[name='"+resource_type+"[file]']").val() == ""){
      alert("<%= t('document.body.title3')%>");
    } else if (resource_type == "link" && $("#AddWriting input[name='"+resource_type+"[url]']").val() == ""){
      alert("<%= t('link.title3')%>");
    } else if (resource_type == "embed" && $("#AddWriting input[name='"+resource_type+"[plaintext]']").val() == "") {
      alert("<%= t('embed.title3')%>");
    } else if (resource_type == "writing" && $("#AddWriting textarea[name='"+resource_type+"[plaintext]']").val() == "") {
      alert("<%= t('writing.title3')%>");
    } else if($("#AddWriting .title").val() == "") {
      alert("<%= t('document.title_alert')%>");
    } else {
      //TITLE
      $("#AddWriting input[name='"+resource_type+"[title]']").val($("#AddWriting .title").val());
      //DESCRIPTION
      $("#AddWriting input[name='"+resource_type+"[description]']").val($("#AddWriting .description").val());
      //TAGS
      var tagList = $("#AddWriting .resourceTagList");
      $("#AddWriting input[name='"+resource_type+"[tag_list][]']").val(Vish.Utils.convertToTagsArray($(tagList).tagit("tags")));
      //Avatar
      var avatarFileInput = $("#AddWriting .new_file_avatar");
      $(avatarFileInput).attr("name",resource_type+"[avatar]");
      var myForm = $("#AddWriting form#new_file_only_new_" + resource_type);
      $(avatarFileInput).css("display","none");
      $(avatarFileInput).appendTo(myForm);
      //LANGUAGE
      $("#AddWriting input[name='"+resource_type+"[language]']").val($("#AddWriting .language").val());
      //AGE
      var value1 = $('#AddWriting .age-slider').data('slider').getValue()[0];
      var value2 = $('#AddWriting .age-slider').data('slider').getValue()[1];
      $('#AddWriting input[name="'+resource_type+'[age_min]"]').val(value1);
      $('#AddWriting input[name="'+resource_type+'[age_max]"]').val(value2);

      $(this).button('loading');
      //SUBMIT
      $("#AddWriting input[value=<%= t('button.save') %>][type='submit'][name='commit'][class='"+resource_type+" hide']").click();
    }
  });

  //Tags
  var resourceTagList = $("#AddWriting .resourceTagList");
  var resourceTags = [];
  
  //Load tags
  $.each($("#AddWriting #resourcePreloadTagList li"), function(index, element) {
     resourceTags.push($(element).html());
  });
          
  if ($(resourceTagList).children().length == 0){
    $(resourceTagList).tagit({tagSource:resourceTags, sortable:true, maxLength:15, maxTags:8 , 
      watermarkAllowMessage: '<%=t('document.tags.addMessage')%>', watermarkDenyMessage: '<%=t('document.tags.limitMessage')%>' });
  }

  //File chooser listener
  $("#AddWriting #new_file_only_document_file").on('change', function(e){
    try{
      var ext = $(this).val().split(".").pop().toLowerCase();
      var imageFormats = ["jpg","jpeg","png","gif","bmp","svg"];
      if(imageFormats.indexOf(ext)!=-1){
        //Its a image
        enableUploadAvatar(false);
      } else {
        enableUploadAvatar(true);
      }
    } catch(e){
      enableUploadAvatar(true);
    }
  });

  var enableUploadAvatar = function(enable){
    var label = $("#AddWriting label.new_file_avatar_label");
    var input = $("#AddWriting input.new_file_avatar");
    $(input).prop('disabled', !enable);

    if(enable===true){
      $(label).removeClass("disabled");
      $(label).show();
      $(input).show();
    }else{
      $(label).addClass("disabled");
      $(label).hide();
      $(input).hide();
    }
  };
});
</script>

