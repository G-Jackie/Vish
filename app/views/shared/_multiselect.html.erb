$("#category_id").multiselect({
      header: false,
      classes: "categorize_select",
      height: 190,
      minWidth: "auto",
      menuWidth: 125,
      noneSelectedText: '<i class="icon-th-large"></i><b class="caret"></b>',
      selectedText: '<i class="icon-th-large"></i><b class="caret"></b>',
      click: function(event, ui){
          $("#apply_category").show();
          $("#add_category").hide();
        },
      beforeopen: function(event, ui){
        if($(".ui-multiselect-menu.categorize_select").children(".separator_line").length==0){
          var piece = '<div class="separator_line"></div><li class=" "><button id="apply_category" title="" style="display:none" class="ui-corner-all ui-state-hover btn btn-primary"><span><%=t('categories.actions.apply')%></span></button><button id="add_category" title="" class="ui-corner-all ui-state-hover btn btn-primary"><span><%=t('categories.actions.add')%></span></button></li>';
          
          $(".ui-multiselect-menu.categorize_select").append(piece);
          $("#add_category").click(function(){
            $("#category_id").multiselect("close");
            $('#AddCategory').modal();
          });
          $("#apply_category").click(function(){            
            var cat_array = [];
            $(".ui-multiselect-checkboxes li input[aria-selected='true']").each(function(index, elem){
              cat_array.push(elem.value);
            });
            $.ajax({
              url: '/categories/add_items',
              type: 'POST',
              dataType: "json",
              data: { item_type:"<%=item.class.to_s%>", item_id:"<%=item.id.to_s%>", categories_array: JSON.stringify(cat_array) }
            });
            
            $("#category_id").multiselect("close");
          });


        }
      }
      });

      $('#AddCategory .new_category').bind('ajax:success', function(evt, data, status, xhr){
        $('#AddCategory').modal('hide');
        //add the new entry to categories
        opt = $('<option />', {
          value: data.id,
          text: data.title
        });               
        opt.appendTo($("#category_id"));
        $("#category_id").multiselect("refresh");
        $("#category_id").multiselect("open");
      });