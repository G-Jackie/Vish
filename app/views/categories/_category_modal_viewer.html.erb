<div id="categories_viewer_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel"><i class="icon-th-large"></i><%= t("category.modalLabel")%></h3>
  </div>
  <div class="modal-body">

    <!-- IIIIIIIIIIIIII-->
    <div class="left_categories">

      <% generic_categories = Category.authored_by(current_subject) %>
      <p class= "information"><%= t("category.cat_popular")%></p> 
<!--popular-->
      <div id="suggested_categories" class="tagBoxNew popular_categories">
        <%simple_gen = generic_categories.sample(5)%>
        
        <ul id="suggestedCategories" class="tagit">
          <% simple_gen.each do |init| %> 
          <li class="tagit-choice" value="<%= init.id %>" ><%=init.title%></li>
          <% end %>
        </ul>
        
      </div>

<!-- MY-->
      <p class= "information"><%= t("category.cat_add_title")%></p> 
      <div class="my_categories">
        <% generic_categories.each do |init| %> 
        <li class="tagit-choice" value="<%=init.id%>"><a ><%=init.title%></a></li>
        <% end %>
      </div>


<!-- new-->

      <%tagArray= generic_categories.map{|e| e.title}%>
      <script type="text/javascript">
        $(document).ready(function() {
          var tagList= [
          <%tagArray.each do |tags|%>
          "<%=tags%>",
          <%end%>
          ];
          $("#myCategories").tagit({
            watermarkAllowMessage: "<%= t('category.tagit_watermark_cat')%>",
            tagSource: tagList
          });
          <% resource_categories = get_initial_categories(item) %>
          <% resource_categories.each do |cat| %>
          <% ident = Category.find(cat) %>
          $("#myCategories").tagit("add", "<%=ident.title %>", "<%=ident.id%>");
          <%end%> 
        //Save suggested categories state

      });
      </script>

      <p class= "information"><%= t("category.cat_create")%></p> 

      <div class="tagBoxNew">
        <ul id="myCategories">
          <!-- Existing list items will be pre-added to the tags -->

        </ul>
      </div>
    </div>


    <!-- IIIIIIIIIIIIII-->

    <!-- DDDDDDDDDDDDddd-->
    <div class="right_categories">
      <p class="information"><%= t("category.categorized_like")%></p>

    </div>

    <!-- DDDDDDDDDDDDddd-->








    </div>
    <div class="modal-footer">
      <button id="cancel_cat_button" class="btn btn_cancel" data-dismiss="modal" aria-hidden="true"><%=t('cancel')%></button>
      <button id="save_cat_button" class="btn btn-primary"><%= t('button.save')%></button>
    </div>
  </div>

  <script>

  //When click to suggested they go to down part for being categorized
  $("#suggested_categories li").click(function(){
    var value = $(this).val();
    var name = $(this).html();

    $("#myCategories").tagit("add", name, value);
  });

  //TODO: Make it work
  $("#categories_select_box select option").click(function(){
    var value = $(this).val();
    var name = $(this).html();

    $("#myCategories").tagit("add", name, value);
  });

  //When saving gathering all tags and sending to server
  $("#save_cat_button").click(function() {
    var cat_done_array = [];

    $("#myCategories .tagit-choice").each(function(index,elem){
      //comprobar primero los que tengan un attrvalue null para crearlos
      if ($(elem).attr("tagvalue") != null){
        cat_done_array.push({id: $(elem).attr("tagvalue")});
      }
      else {
        cat_done_array.push({title: $(elem).text()});
      }
    });

    $.ajax({
      url: '/categories/categorize',
      type: 'POST',
      dataType: "json",
      data: { activity_object_id:"<%=item.activity_object.id
      .to_s%>", category_array: JSON.stringify(cat_done_array) },
      success: function(data){    
        $("#categories_viewer_modal").modal('toggle');

      }
    });
  });

  $("#cancel_cat_button").click(function() {
    $("#myCategories").tagit("reset");
    for (key in appliedTags){
      $("#myCategories").tagit("add",appliedTags[key]);
    }
    $("#categories_viewer_modal").modal('toggle');
  });

  var appliedTags = [];
  $('#categories_viewer_modal').on('shown', function() {
    $("#myCategories .tagit-choice").each(function(index,elem){
      appliedTags.push($(elem).text());
    });
  });

</script>